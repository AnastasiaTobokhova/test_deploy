name: CI/CD Pipeline

on:
  repository_dispatch:
    types: [deploy]
  workflow_dispatch:
  
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
        uses: actions/checkout@v4

      - name: ğŸ³ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io

      - name: ğŸ”¨ Ğ‘Ğ¸Ğ»Ğ´Ğ¸Ğ¼ Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·
        run: |
          docker build -t ${{ secrets.REGISTRY_ID }}/${{ github.event.client_payload.image_name }}:latest .

      - name: ğŸš€ ĞŸÑƒÑˆĞ¸Ğ¼ Docker-Ğ¾Ğ±Ñ€Ğ°Ğ· Ğ² Yandex Cloud
        run: |
          echo ${{ secrets.YC_OAUTH_TOKEN }} | docker login --username oauth --password-stdin cr.yandex
          docker push ${{ secrets.REGISTRY_ID }}/${{ github.event.client_payload.image_name }}:latest

      - name: ğŸŒ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
        run: |
          ssh -o StrictHostKeyChecking=no yc-user@${{ secrets.VM_IP }} "
          docker stop ${{ github.event.client_payload.image_name }} || true
          docker rm ${{ github.event.client_payload.image_name }} || true
          docker pull ${{ secrets.REGISTRY_ID }}/${{ github.event.client_payload.image_name }}:latest
          docker run -d --name ${{ github.event.client_payload.image_name }} -p 80:80 ${{ secrets.REGISTRY_ID }}/${{ github.event.client_payload.image_name }}:latest
          "
